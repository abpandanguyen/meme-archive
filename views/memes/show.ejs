<%- include('../partials/header')%>
<body id="showPage">
  <nav>
    <span>
      <a href="/memes">Meme Archive</a>&nbsp;&nbsp;
      <% if (user) { %>
        <a href="/memes/new">Add Meme</a>&nbsp;&nbsp;
        <a href="/memes/posts">Your Posts</a>&nbsp;&nbsp;
        <a href="/memes/favorites">Favorites</a>&nbsp;&nbsp;
        <a href="/logout">Log Out</a>&nbsp;&nbsp;
      <% } else { %>
        <a href="/auth/google" class="login">LOG IN<img src="https://i.imgur.com/FHjYyi0.png"></a>
      <% } %>
    </span>
  </nav>

<section id="show page">
    <div id="showPageHeader">Meme</div>
    <div><img width="300px" src="<%= meme.link %>"></div>
    <br>
    <div>Source: </div>
    <div><%= meme.source %></div>
    <br>
    <div>Origin Date: </div>
    <div><%= String(meme.dateOrigin).substr(3, 13) %></div>
    <br>
    <div>Description: </div>
    <div><%= meme.description %></div>
    <br>
    <div>Posted By:</div>
    <div><%= meme.userName %></div>
    <% if (user && user.equals(meme.user)) { %>
        <div><a href="/memes/<%= meme.id %>/edit">Edit Meme</a></div>
        <br>
        <form action="/memes/<%= meme._id %>?_method=DELETE" method="POST">
          <button type="submit">Delete Meme</button>
        </form>
    <% } %>
</section>
<br>
<% if (user) { %>
  <form id="add-favorite-form" method="POST"
      action ="/memes/<%= meme._id %>/favorites">
        <input type="submit" value="Favorite Meme">
  </form>
<% } %>

<br>

<% if (user) { %>
  <form id="add-comment-form" method="POST" 
    action ="/memes/<%= meme._id %>/comments">
    <label>Comment:</label>
    <br>
    <textarea id="description-comment" placeholder="Be nice!" name="content"></textarea>
    <br>
    <label>Rating:</label>
    <select name="rating">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5" selected>5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
    </select>
    <input type="submit" value="Add Comment">
  </form>
<% } %>

<% if (meme.comments.length) { %>
  <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Comment</th>
          <th>Rating</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% let sum = 0; %>
        <% meme.comments.forEach(function(c) { %>
          <% sum += c.rating %>
          <tr>
            <td><%= c.userName %></td>
            <td><%= c.createdAt.toLocaleDateString() %></td>
            <td><%= c.content %></td>
            <td><%= c.rating %></td>
            <td>
              <% if ( user?._id.equals(c.user) ) { %>
              <form action="/comments/<%= c._id %>?_method=DELETE" method="POST">
                <button type="submit">Delete Comment</button>
              </form>
            <% } %>
              </td>
          </tr>
        <% }); %>
          <tr>
            <td colspan="3"></td>
            <td><%= (sum / meme.comments.length).toFixed(2) %></td>
          </tr>
      </tbody>
    </table>
  <% } else { %>
    <h5>No Comments Yet</h5>
<% } %>


<%- include('../partials/footer')%>